<!-- templates/admin/edit_news.html -->
{% extends "admin/base.html" %}

{% block title %}Edit News - Admin Panel{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Edit News</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('admin_news_list') }}" class="btn btn-sm btn-outline-secondary me-2">
            <i class="fas fa-arrow-left me-1"></i> Back to News List
        </a>
        <a href="{{ url_for('news_detail', news_id=news._id) }}" class="btn btn-sm btn-outline-primary" target="_blank">
            <i class="fas fa-eye me-1"></i> View Live
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header bg-warning text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Edit News Article
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin_edit_news', news_id=news._id) }}" enctype="multipart/form-data" id="editNewsForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">News Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" id="title" name="title" 
                                       value="{{ news.title }}" required maxlength="200">
                                <div class="form-text">Maximum 200 characters</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                                <select class="form-select" id="category" name="category" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category }}" {% if news.category == category %}selected{% endif %}>
                                        {{ category }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="image" class="form-label">Featured Image</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                        <div class="form-text">
                            {% if news.image %}
                            Current image: <strong>{{ news.image }}</strong>. Upload a new image to replace it.
                            {% else %}
                            No image currently set. Upload a featured image.
                            {% endif %}
                        </div>
                        
                        <!-- Current Image Preview -->
                        {% if news.image %}
                        <div class="mt-3">
                            <label class="form-label">Current Image:</label>
                            <div class="current-image-container">
                                <img src="{{ url_for('static', filename='uploads/' + news.image) }}" 
                                     class="img-thumbnail" 
                                     style="max-height: 200px;"
                                     alt="Current featured image">
                                <div class="mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="removeImage" name="remove_image">
                                        <label class="form-check-label text-danger" for="removeImage">
                                            Remove current image
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- New Image Preview -->
                        <div class="mt-2" id="newImagePreviewContainer" style="display: none;">
                            <label class="form-label">New Image Preview:</label>
                            <img id="newImagePreview" class="img-thumbnail" style="max-height: 200px;">
                            <button type="button" class="btn btn-sm btn-danger mt-2 d-block" onclick="removeNewImage()">
                                <i class="fas fa-times me-1"></i>Remove New Image
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">News Content <span class="text-danger">*</span></label>
                        <textarea class="form-control rich-text-editor" id="content" name="content" rows="15" required>{{ news.content }}</textarea>
                        <div class="form-text">You can use basic HTML formatting in the content.</div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Character Count</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <span id="charCount">0</span> characters
                                    </span>
                                    <span class="input-group-text">
                                        <span id="wordCount">0</span> words
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Reading Time</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <span id="readingTime">0</span> min read
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Article Statistics -->
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-chart-bar me-2"></i>Article Statistics
                            </h6>
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="border-end">
                                        <h4 class="text-primary mb-0">{{ news.views }}</h4>
                                        <small class="text-muted">Total Views</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border-end">
                                        <h4 class="text-success mb-0">{{ news.date_created.strftime('%Y-%m-%d') }}</h4>
                                        <small class="text-muted">Created Date</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border-end">
                                        <h4 class="text-info mb-0">{{ news.date_updated.strftime('%Y-%m-%d') }}</h4>
                                        <small class="text-muted">Last Updated</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div>
                                        <h4 class="text-warning mb-0">{{ news._id }}</h4>
                                        <small class="text-muted">Article ID</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="border-top pt-3 mt-4">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="button" class="btn btn-outline-danger me-2" onclick="confirmDelete()">
                                    <i class="fas fa-trash me-1"></i> Delete Article
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="previewNews()">
                                    <i class="fas fa-eye me-1"></i> Preview
                                </button>
                            </div>
                            <div>
                                <button type="reset" class="btn btn-secondary me-2">
                                    <i class="fas fa-redo me-1"></i> Reset Changes
                                </button>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save me-1"></i> Update News
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Revision History -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Revision History
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <h6 class="mb-0">Article Created</h6>
                            <small class="text-muted">{{ news.date_created.strftime('%B %d, %Y at %H:%M') }}</small>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker bg-warning"></div>
                        <div class="timeline-content">
                            <h6 class="mb-0">Last Updated</h6>
                            <small class="text-muted">{{ news.date_updated.strftime('%B %d, %Y at %H:%M') }}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('admin_add_news') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-plus me-1"></i> Create New Article
                    </a>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="duplicateArticle()">
                        <i class="fas fa-copy me-1"></i> Duplicate This Article
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="resetToOriginal()">
                        <i class="fas fa-undo me-1"></i> Reset to Original
                    </button>
                </div>
            </div>
        </div>

        <!-- SEO Suggestions -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-search me-2"></i>SEO Checklist
                </h6>
            </div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="seoTitle" {% if news.title|length <= 60 %}checked{% endif %}>
                    <label class="form-check-label small" for="seoTitle">
                        Title length: {{ news.title|length }}/60 characters
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="seoContent" {% if news.content|length >= 300 %}checked{% endif %}>
                    <label class="form-check-label small" for="seoContent">
                        Content length: {{ news.content|length }}/300 characters
                    </label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="seoImage" {% if news.image %}checked{% endif %}>
                    <label class="form-check-label small" for="seoImage">
                        Featured image included
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="seoReadability" checked>
                    <label class="form-check-label small" for="seoReadability">
                        Good readability score
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">News Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentTextarea = document.getElementById('content');
    const charCount = document.getElementById('charCount');
    const wordCount = document.getElementById('wordCount');
    const readingTime = document.getElementById('readingTime');
    const imageInput = document.getElementById('image');
    const newImagePreview = document.getElementById('newImagePreview');
    const newImagePreviewContainer = document.getElementById('newImagePreviewContainer');

    // Initialize counts
    updateCounts();

    // Character and word count
    contentTextarea.addEventListener('input', updateCounts);

    function updateCounts() {
        const text = contentTextarea.value;
        const characters = text.length;
        const words = text.trim() ? text.trim().split(/\s+/).length : 0;
        const readingTimeMinutes = Math.ceil(words / 200);

        charCount.textContent = characters;
        wordCount.textContent = words;
        readingTime.textContent = readingTimeMinutes;
    }

    // New image preview
    imageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                newImagePreview.src = e.target.result;
                newImagePreviewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Form validation
    const form = document.getElementById('editNewsForm');
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const category = document.getElementById('category').value;
        const content = document.getElementById('content').value.trim();

        if (!title || !category || !content) {
            e.preventDefault();
            alert('Please fill in all required fields (title, category, and content).');
            return;
        }

        if (title.length > 200) {
            e.preventDefault();
            alert('Title must be 200 characters or less.');
            return;
        }

        // Show loading state
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Updating...';
    });
});

function removeNewImage() {
    const imageInput = document.getElementById('image');
    const newImagePreviewContainer = document.getElementById('newImagePreviewContainer');
    
    imageInput.value = '';
    newImagePreviewContainer.style.display = 'none';
}

function previewNews() {
    const title = document.getElementById('title').value || 'Untitled News';
    const content = document.getElementById('content').value || 'No content provided.';
    const currentImage = '{{ news.image }}';
    const newImagePreview = document.getElementById('newImagePreview');
    
    let previewHtml = `
        <h2>${title}</h2>
        <hr>
    `;
    
    if (newImagePreview.src) {
        previewHtml += `<img src="${newImagePreview.src}" class="img-fluid mb-3" alt="Preview Image">`;
    } else if (currentImage && !document.getElementById('removeImage').checked) {
        previewHtml += `<img src="{{ url_for('static', filename='uploads/' + news.image) }}" class="img-fluid mb-3" alt="Current Image">`;
    }
    
    previewHtml += `<div>${content.replace(/\n/g, '<br>')}</div>`;
    
    document.getElementById('previewContent').innerHTML = previewHtml;
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function confirmDelete() {
    if (confirm('Are you sure you want to delete this news article? This action cannot be undone.')) {
        window.location.href = "{{ url_for('admin_delete_news', news_id=news._id) }}";
    }
}

function duplicateArticle() {
    if (confirm('Create a copy of this article?')) {
        // This would typically be handled by a separate endpoint
        // For now, we'll show a message
        alert('Duplication feature would be implemented here. This would create a copy of the current article.');
    }
}

function resetToOriginal() {
    if (confirm('Reset all changes and restore original content?')) {
        // Reload the page to reset the form
        window.location.reload();
    }
}
</script>

<style>
.timeline {
    position: relative;
    padding-left: 20px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -20px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.timeline-content {
    padding-left: 10px;
}

.rich-text-editor {
    min-height: 300px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
}

#previewContent {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
}

#previewContent h2 {
    color: #0d6efd;
    margin-bottom: 1rem;
}

#previewContent h3 {
    color: #495057;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

#previewContent p {
    margin-bottom: 1rem;
}
</style>
{% endblock %}